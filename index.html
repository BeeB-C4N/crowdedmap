<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金沢中心部　観光混雑度マップ</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- PapaParse CDN URL updated to a stable one -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">

    <style>
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Shippori Mincho', serif; 
            background: linear-gradient(to bottom, #0c0c1e, #000000);
            color: #f0f0f0; 
        }
        .golden-text { background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .content-box { background-color: rgba(0, 0, 0, 0.4); border: 1px solid #BF953F; border-radius: 8px; padding: 1.5rem; backdrop-filter: blur(8px); }

        /* Header Style */
        .header-container {
            position: relative;
            padding: 3rem 1rem;
            border-radius: 8px;
            overflow: hidden;
            background-size: cover;
            background-position: center 30%;
        }
        .header-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1;
        }
        .header-container > * {
            position: relative;
            z-index: 2;
        }

        /* Tab Styles */
        .tabs { border-bottom: 1px solid #BF953F; display: flex; }
        .tab-btn { flex-grow: 1; text-align: center; padding: 0.75rem 1rem; cursor: pointer; background-color: transparent; border: none; color: #a0a0a0; font-size: 1.1rem; transition: all 0.2s; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: #FCF6BA; border-bottom: 3px solid #BF953F; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Map Styles */
        #map { height: 80vh; width: 100%; border-radius: 8px; background-color: #333; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: rgba(26, 26, 26, 0.9); color: #f0f0f0; border: 1px solid #BF953F; box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
        .leaflet-popup-content h3 { font-size: 1.2rem; font-weight: bold; color: #FCF6BA; }
        .leaflet-popup-content p { margin: 0.5em 0; }
        .custom-div-icon .marker-container { border-radius: 50%; overflow: hidden; box-shadow: 0 0 10px rgba(252, 246, 186, 0.7); transition: transform 0.2s ease-in-out; background-color: #1a1a1a; }
        .custom-div-icon .marker-container:hover { transform: scale(1.1); }
        .custom-div-icon img { width: 100%; height: 100%; object-fit: cover; }

        /* Calendar Styles */
        .calendar-table { border-collapse: separate; border-spacing: 2px; width: 100%; table-layout: fixed; }
        .calendar-table th, .calendar-table td { text-align: center; padding: 8px 4px; border: 1px solid #444; }
        .calendar-table th { background-color: #333; color: #BF953F; font-size: 0.9em; height: 50px; }
        .calendar-table td.time-header { background-color: #2a2a2a; font-weight: bold; color: #FCF6BA; text-align: center; width: 80px; }

        /* Today's Column Highlight */
        .calendar-table .today-header { color: #FCF6BA; font-weight: bold; }
        .calendar-table .today-column { border-left: 1px solid #BF953F; border-right: 1px solid #BF953F; }
        .calendar-table th.today-column { border-top: 1px solid #BF953F; }
        .calendar-table tr:last-child td.today-column { border-bottom: 1px solid #BF953F;}

        /* Introduction Tab Styles */
        #introduction-content .facility-card { background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        @media (min-width: 768px) { #introduction-content .facility-card { flex-direction: row; } }
        #introduction-content .facility-card img { width: 100%; height: 200px; object-fit: cover; }
        @media (min-width: 768px) { #introduction-content .facility-card img { width: 300px; height: auto; flex-shrink: 0; } }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-container { background: #1e1e1e; border: 1px solid #BF953F; color: #f0f0f0; border-radius: 8px; padding: 2rem; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-header { border-bottom: 1px solid #BF953F; padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-content { overflow-y: auto; flex-grow: 1; }
        .modal-footer { margin-top: 1.5rem; text-align: right; }

        /* Shared Styles */
        .level-1-bg { background-color: #166534; } .level-2-bg { background-color: #a16207; } .level-3-bg { background-color: #991b1b; }
        .future-time-bg { background-color: #4b5563; }
        .level-1-border { border: 4px solid #22c55e; } .level-2-border { border: 4px solid #f59e0b; } .level-3-border { border: 4px solid #ef4444; }
        .level-1-text { color: #22c55e; } .level-2-text { color: #f59e0b; } .level-3-text { color: #ef4444; }
        .btn-gold { background: linear-gradient(to right, #BF953F, #AA771C); color: white; padding: 8px 16px; border-radius: 6px; border: 1px solid #FCF6BA; transition: all 0.2s; }
        .btn-gold:hover { box-shadow: 0 0 10px #FCF6BA; transform: translateY(-2px); }
        .legend-item { display: flex; align-items: center; }
        .legend-color-box { height: 1rem; width: 1rem; border-radius: 9999px; border: 2px solid #e5e7eb; margin-right: 0.5rem; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 header-container">
            <h1 class="text-4xl md:text-5xl font-bold golden-text tracking-wider">金沢市 観光混雑度マップ</h1>
            <p class="text-gray-300 mt-2">Kanazawa Congestion Map</p>
        </header>

        <main class="content-box">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="map-content">マップ</button>
                <button class="tab-btn" data-tab="calendar-content">カレンダー</button>
                <button class="tab-btn" data-tab="introduction-content">施設紹介</button>
            </div>

            <!-- Map Content -->
            <div id="map-content" class="tab-content active pt-6">
                <h2 class="text-xl font-bold mb-4 golden-text">リアルタイム混雑状況</h2>
                <div id="map"></div>
                <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 mt-4 text-sm">
                    <div class="legend-item"><span class="legend-color-box bg-[#22c55e]"></span>ゆっくりと観光いただけます</div>
                    <div class="legend-item"><span class="legend-color-box bg-[#f59e0b]"></span>通常の混み具合です</div>
                    <div class="legend-item"><span class="legend-color-box bg-[#ef4444]"></span>多くの観光客で賑わっています</div>
                </div>
            </div>
            
            <!-- Calendar Content -->
            <div id="calendar-content" class="tab-content pt-6">
                 <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                    <div>
                        <h2 id="calendar-title" class="text-xl font-bold golden-text">時間帯別 混雑度実績</h2>
                        <p id="calendar-info" class="text-gray-400">施設全体（本日）</p>
                    </div>
                    <button id="calendar-toggle-btn" class="btn-gold self-start md:self-center"></button>
                </div>
                 <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 mb-4 text-sm">
                    <div class="legend-item"><span class="legend-color-box bg-[#166534]"></span>ゆっくり</div>
                    <div class="legend-item"><span class="legend-color-box bg-[#a16207]"></span>通常</div>
                    <div class="legend-item"><span class="legend-color-box bg-[#991b1b]"></span>混雑</div>
                </div>
                <div class="overflow-x-auto">
                    <div id="calendar-container"></div>
                </div>
            </div>

            <!-- Introduction Content -->
            <div id="introduction-content" class="tab-content pt-6 space-y-8">
                <!-- Facility cards will be inserted here by JS -->
            </div>
        </main>
        
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>&copy; 2024 Code for Noto. All Rights Reserved.</p>
            <a href="#" id="disclaimer-link" class="underline hover:text-golden-text transition">免責事項</a>
        </footer>
    </div>

    <!-- Modal -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="text-2xl font-bold golden-text">免責事項</h2>
            </div>
            <div class="modal-content">
                <p class="mb-4">本ウェブサイトで提供される混雑度情報は、Wi-Fiセンシングデータを用いた参考情報です。リアルタイムの状況を完全に保証するものではありません。</p>
                <p class="mb-4">この情報は、提供されたデータに基づいて生成されており、実際の混雑状況とは異なる場合があります。通信状況やシステムの都合により、情報の更新が遅れることや、表示されないことがあります。</p>
                <p class="mb-4">本ウェブサイトの利用によって生じたいかなる損害についても、運営者は一切の責任を負いません。お出かけの際の判断は、ご自身の責任でお願いいたします。</p>
                <p>掲載されている情報は、予告なく変更または削除されることがありますので、あらかじめご了承ください。</p>
            </div>
            <div class="modal-footer">
                <button id="close-modal-btn" class="btn-gold">閉じる</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- Configuration ---
            const DATA_PATHS = {
                master: './data/crowded_milli_master.csv',
                criterion: './data/crowded_milli_criterion.csv',
                milli: './data/crowded_milli.csv'
            };

            const IMAGE_URLS = {
                "兼六園": "./images/兼六園.jpg",
                "近江町市場": "./images/近江町市場.jpg",
                "ひがし茶屋街": "./images/ひがし茶屋街.jpg",
                "金沢21世紀美術館": "./images/金沢21世紀美術館.jpg",
                "金沢駅": "./images/金沢駅.jpg",
                "金沢城公園": "./images/金沢城公園.jpg",
            };
            
            const HEADER_IMAGE_URL = './images/金沢駅.jpg';
            document.querySelector('.header-container').style.backgroundImage = `url('${HEADER_IMAGE_URL}')`;


            const CONGESTION_LEVELS = {
                1: { message: "ゆっくりと観光いただけます", className: "level-1" },
                2: { message: "通常の混み具合です", className: "level-2" },
                3: { message: "多くの観光客で賑わっています", className: "level-3" }
            };

            // --- Utility Functions ---
            const normalizeNumbers = (str) => {
                if (!str) return str;
                return str.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
            };

            const loadCsvData = async (path) => {
                try {
                    const response = await fetch(path);
                    if (!response.ok) throw new Error(`Failed to load ${path}: ${response.statusText}`);
                    const csvText = await response.text();
                    // BOM (Byte Order Mark) removal
                    const cleanCsvText = csvText.replace(/^\uFEFF/, '');
                    return new Promise(resolve => {
                        Papa.parse(cleanCsvText, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => resolve(results.data),
                            error: (err) => { console.error(`Error parsing ${path}:`, err); resolve([]); }
                        });
                    });
                } catch (error) {
                    console.error(`Error fetching ${path}:`, error);
                    return [];
                }
            };

            // --- Main Application Logic ---
            try {
                const [masterData, criterionData, milliData] = await Promise.all([
                    loadCsvData(DATA_PATHS.master),
                    loadCsvData(DATA_PATHS.criterion),
                    loadCsvData(DATA_PATHS.milli)
                ]);
                
                if (!masterData.length || !criterionData.length || !milliData.length) {
                    throw new Error("One or more data files could not be loaded or are empty.");
                }

                const facilityData = masterData.map(master => {
                    if (!master.地点名) return null;
                    const masterName = normalizeNumbers(master.地点名.trim());
                    const criterion = criterionData.find(c => c.地点名 && normalizeNumbers(c.地点名.trim()) === masterName);
                    const milli = milliData.filter(m => m.施設 && normalizeNumbers(m.施設.trim()) === masterName);
                    return { ...master, criterion, milli };
                }).filter(f => f && f.緯度 && f.経度);

                const map = L.map('map').setView([36.565, 136.658], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                }).addTo(map);
                
                L.Util.getMapInstance = () => map;

                populateIntroductionTab(facilityData);
                updateMap(facilityData);
                displayTodayAllFacilitiesCalendar(facilityData);
                setupEventListeners(facilityData);

            } catch (error) {
                console.error("Application failed to initialize:", error);
                const mainContent = document.querySelector('main');
                mainContent.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl text-red-500">エラー</h2><p class="mt-4 text-gray-300">データの読み込みに失敗しました。CSVファイルがUTF-8で保存されているか、ファイルパスやファイル名が正しいかを確認してください。</p></div>`;
            }
            
            function setupEventListeners(facilityData) {
                const tabs = document.querySelectorAll('.tab-btn');
                const map = L.Util.getMapInstance('map');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => switchToTab(tab.dataset.tab, map));
                });
                
                map.on('popupopen', (e) => {
                    const btn = e.popup.getElement().querySelector('.popup-calendar-btn');
                    if (btn) {
                        btn.addEventListener('click', () => {
                            const facility = facilityData.find(f => f.地点名 === btn.dataset.facilityName);
                            if (facility) {
                                displayDailyCalendarForFacility(facility, facilityData);
                                switchToTab('calendar-content', map);
                            }
                        });
                    }
                });

                document.getElementById('introduction-content').addEventListener('click', (e) => {
                    if (e.target.matches('.intro-calendar-btn')) {
                        const facility = facilityData.find(f => f.地点名 === e.target.dataset.facilityName);
                        if (facility) {
                            displayDailyCalendarForFacility(facility, facilityData);
                            switchToTab('calendar-content', map);
                        }
                    }
                });

                const disclaimerLink = document.getElementById('disclaimer-link');
                const modalOverlay = document.getElementById('modal-overlay');
                const closeModalBtn = document.getElementById('close-modal-btn');
                
                disclaimerLink.addEventListener('click', (e) => { e.preventDefault(); modalOverlay.style.display = 'flex'; });
                closeModalBtn.addEventListener('click', () => modalOverlay.style.display = 'none');
                modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.style.display = 'none'; });
            }

            function switchToTab(tabId, map) {
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.toggle('active', tc.id === tabId));
                if (tabId === 'map-content' && map) setTimeout(() => map.invalidateSize(), 1);
            }

            function getCongestionLevel(count, criterion) {
                if (!criterion) return 1;
                const num = parseInt(count, 10);
                if (isNaN(num)) return 1;
                if (num <= parseInt(criterion.notcrowded, 10)) return 1;
                if (num <= parseInt(criterion.normal, 10)) return 2;
                return 3;
            }
            
            function createCustomIcon(level, facilityName) {
                const levelInfo = CONGESTION_LEVELS[level];
                const imageUrl = IMAGE_URLS[facilityName] || `./images/金沢駅.jpg`;
                return L.divIcon({
                    html: `<div class="marker-container ${levelInfo.className}-border"><img src="${imageUrl}" alt="${facilityName}" onerror="this.onerror=null;this.src='./images/金沢駅.jpg';"></div>`,
                    className: 'custom-div-icon', iconSize: [80, 80], iconAnchor: [40, 80], popupAnchor: [0, -80]
                });
            }

            function updateMap(facilityData) {
                const map = L.Util.getMapInstance('map');
                if (!map) return;
                
                const today = new Date();
                const latestDate = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
                const currentHour = today.getHours();

                facilityData.forEach(facility => {
                    const lat = parseFloat(facility.緯度);
                    const lon = parseFloat(facility.経度);
                    if (isNaN(lat) || isNaN(lon)) return;
                    
                    const latestRecord = facility.milli
                        .filter(d => d.年月日 === latestDate && parseInt(d.時刻, 10) <= currentHour)
                        .sort((a, b) => parseInt(b.時刻, 10) - parseInt(a.時刻, 10))[0];

                    const currentCount = latestRecord ? latestRecord.人数 : 0;
                    const level = getCongestionLevel(currentCount, facility.criterion);
                    const levelInfo = CONGESTION_LEVELS[level];

                    const marker = L.marker([lat, lon], { icon: createCustomIcon(level, facility.地点名) }).addTo(map);
                    
                    const popupContent = `
                        <h3 class="golden-text">${facility.地点名}</h3>
                        <p>現在の混雑状況: <strong class="${levelInfo.className}-text">${levelInfo.message}</strong></p>
                        <button class="btn-gold popup-calendar-btn mt-2 w-full" data-facility-name="${facility.地点名}">時間帯別で表示</button>`;
                    marker.bindPopup(popupContent);
                });
            }
            
            function populateIntroductionTab(facilityData) {
                const container = document.getElementById('introduction-content');
                container.innerHTML = '';
                facilityData.forEach(facility => {
                    const imageUrl = IMAGE_URLS[facility.地点名] || `./images/金沢駅.jpg`;
                    const cardHtml = `
                        <div class="facility-card">
                            <img src="${imageUrl}" alt="${facility.地点名}" onerror="this.onerror=null;this.src='./images/金沢駅.jpg';">
                            <div class="p-6 flex flex-col">
                                <h3 class="text-2xl font-bold golden-text">${facility.地点名}</h3>
                                <p class="text-gray-400 mb-4">${facility.英語名称 || ''}</p>
                                <p class="text-gray-300 flex-grow">${facility.説明 || ''}</p>
                                <button class="btn-gold intro-calendar-btn mt-4 self-start" data-facility-name="${facility.地点名}">本日の混雑度を確認する</button>
                            </div>
                        </div>`;
                    container.innerHTML += cardHtml;
                });
            }

            function displayTodayAllFacilitiesCalendar(facilityData) {
                const map = L.Util.getMapInstance('map');
                document.getElementById('calendar-title').textContent = '時間帯別 混雑度実績';
                document.getElementById('calendar-info').textContent = '施設全体（本日）';
                const toggleBtn = document.getElementById('calendar-toggle-btn');
                toggleBtn.textContent = '施設ごとの混雑度を表示';
                toggleBtn.onclick = () => switchToTab('introduction-content', map);

                const today = new Date();
                const latestDate = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
                const currentHour = today.getHours();

                let headerHtml = '<tr><th>時刻</th>';
                facilityData.forEach(facility => { headerHtml += `<th>${facility.地点名}</th>`; });
                headerHtml += '</tr>';

                const dataByFacilityAndHour = {};
                facilityData.forEach(facility => {
                    dataByFacilityAndHour[facility.地点名] = facility.milli
                        .filter(d => d.年月日 === latestDate)
                        .reduce((acc, row) => { acc[parseInt(row.時刻, 10)] = row.人数; return acc; }, {});
                });

                let bodyHtml = '';
                for (let hour = 8; hour <= 20; hour++) {
                    bodyHtml += `<tr><td class="time-header">${String(hour).padStart(2, '0')}:00</td>`;
                    facilityData.forEach(facility => {
                        if (hour > currentHour) { bodyHtml += `<td class="future-time-bg"></td>`; return; }
                        if (!facility.criterion) { bodyHtml += `<td>-</td>`; return; }
                        const count = dataByFacilityAndHour[facility.地点名][hour] || 0;
                        const level = getCongestionLevel(count, facility.criterion);
                        bodyHtml += `<td class="${CONGESTION_LEVELS[level].className}-bg" title="${count}人"></td>`;
                    });
                    bodyHtml += '</tr>';
                }
                document.getElementById('calendar-container').innerHTML = `<table class="calendar-table"><thead>${headerHtml}</thead><tbody>${bodyHtml}</tbody></table>`;
            }

            function displayDailyCalendarForFacility(facility, facilityData) {
                const map = L.Util.getMapInstance('map');
                document.getElementById('calendar-title').textContent = `${facility.地点名} 混雑度実績`;
                document.getElementById('calendar-info').textContent = '施設別（日別） - 過去7日間';
                const toggleBtn = document.getElementById('calendar-toggle-btn');
                toggleBtn.textContent = '施設全体（本日）表示';
                toggleBtn.onclick = () => displayTodayAllFacilitiesCalendar(facilityData);
                
                const today = new Date();
                const currentHour = today.getHours();
                const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
                let headerHtml = '<tr><th>時刻</th>';
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const isToday = date.toDateString() === today.toDateString();
                    const thClass = isToday ? 'today-header today-column' : '';
                    headerHtml += `<th class="${thClass}">${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}<br>(${weekdays[date.getDay()]})</th>`;
                }
                headerHtml += '</tr>';

                let bodyHtml = '';
                for (let hour = 8; hour <= 20; hour++) {
                    bodyHtml += `<tr><td class="time-header">${String(hour).padStart(2, '0')}:00</td>`;
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const isToday = date.toDateString() === today.toDateString();
                        const todayClass = isToday ? 'today-column' : '';
                        let cellClass = todayClass;

                        if (isToday && hour > currentHour) {
                             cellClass += ' future-time-bg';
                             bodyHtml += `<td class="${cellClass.trim()}"></td>`;
                             continue;
                        }

                        const dateString = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                        const record = facility.milli.find(d => d.年月日 === dateString && parseInt(d.時刻, 10) === hour);
                        const count = record ? record.人数 : 0;
                        const level = getCongestionLevel(count, facility.criterion);
                        cellClass += ` ${CONGESTION_LEVELS[level].className}-bg`;
                        bodyHtml += `<td class="${cellClass.trim()}" title="${count}人"></td>`;
                    }
                    bodyHtml += '</tr>';
                }
                document.getElementById('calendar-container').innerHTML = `<table class="calendar-table"><thead>${headerHtml}</thead><tbody>${bodyHtml}</tbody></table>`;
            }
        });
    </script>
</body>
</html>

